<!DOCTYPE html>
<html>
<head>
  <title>Task Manager</title>
  <script>
    // DOM-based XSS vulnerability =
    window.onload = function() {
      if (window.location.hash) {
        document.getElementById('welcome-message').innerHTML = 'Welcome back, ' + window.location.hash.substring(1);
      }
      
      // DOM-based XSS vulnerability 
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
      
      const theme = getQueryParam('theme');
      if (theme) {
        document.getElementById('theme-message').innerHTML = 'Current theme: <strong>' + theme + '</strong>';
      }
    }
  </script>
</head>
<body>
  <h1>Task Manager</h1>
  
  <% if (typeof user !== 'undefined' && user) { %>
    <p>Welcome, <%= user.username %>! (<%= user.role %>)</p>
    <a href="/profile">Profile</a> | <a href="/logout">Logout</a>
  <% } else { %>
    <a href="/login">Login</a> | <a href="/register">Register</a>
  <% } %>
  
  <div id="welcome-message"></div>
  <div id="theme-message"></div>
  
  <form action="/" method="get">
    <input type="text" name="search" value="<%= searchTerm %>" placeholder="Search tasks">
    <button type="submit">Search</button>
  </form>
  
  <a href="/add">Add New Task</a>
  
  <div class="tasks">
    <% if (tasks && tasks.length > 0) { %>
      <% tasks.forEach(task => { %>
        <div class="task-item">
          <!-- Stored XSS vulnerability -->
          <h3><%- task.title %></h3>
          <p><%- task.description %></p>
          <p>Created: <%= task.created_at %></p>
          <% if (typeof task.username !== 'undefined' && task.username) { %>
            <p>Owner: <%= task.username %></p>
          <% } %>
          
          <% if (task.completed) { %>
            <p>Status: Completed</p>
          <% } else { %>
            <p>Status: Pending</p>
            <form method="post" action="/complete/<%= task.id %>">
              <button type="submit">Mark as Complete</button>
            </form>
          <% } %>
          
          <form method="post" action="/delete/<%= task.id %>">
            <button type="submit">Delete</button>
          </form>
          
          <a href="/task/<%= task.id %>">View Details</a>
        </div>
      <% }); %>
    <% } else { %>
      <p>No tasks found. Add a new task to get started!</p>
    <% } %>
  </div>
</body>
</html>